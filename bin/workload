#!/usr/bin/env ruby
require_relative '../lib/signal_handlers.rb'
require_relative '../lib/github.rb'
require_relative '../lib/git.rb'
require_relative '../lib/helpers.rb'
require 'optparse'
require 'rubygems'
require 'table_print'

options = {}
OptionParser.new do |opts|
   opts.banner = 'Usage: workload [OPTIONS] --milestone=TITLE'
   opts.separator ''
   opts.separator 'Starts or stops AWS machines matching certain specifications.'
   opts.separator ''
   opts.separator 'Example: workload [OPTIONS] --repo="ifixit/git-scripts" --milestone="Guide i18n"'
   opts.separator ''

   opts.on('-m', '--milestone [TITLE]', String, 'Filter down to issues within a milestone') do |milestone|
      options[:milestone] = milestone
   end

   opts.on('-r', '--repo [NAME]', String, "Look at a repo you're not currently in") do |repo|
      options[:repo] = repo
   end
end.parse!

repo = options[:repo] || Github.get_github_repo

ALL = 'all'
READY = 's-Ready'
IN_PROGRESS = 'In Progress'
UNDER_REVIEW = 's-Under Review'

filters = {}

if options[:milestone]
   milestones = Github.api.list_milestones(repo, {
      :state => 'open',
   })
   milestoneNum = milestones.select do |m|
      m.title == 'Week ending 4/25'
   end.first.number

   filters[:milestone] = milestoneNum
end

issues = Github.api.list_issues(repo, filters)
users = {}

issues.each do |issue|
   next unless issue['assignee']
   login = issue['assignee']['login']
   users[login] = {} if users[login].nil?
   user = users[login]

   user['count'] = 0 if user['count'].nil?
   if user['score'].nil?
      user['score'] = {}
      s = user['score']
      s[ALL] = s[READY] = s[IN_PROGRESS] = s[UNDER_REVIEW] = 0
   end

   user['count'] += 1

   labels = issue['labels'].map { |l| l['name'] }

   labels.each do |label|
      if label.to_i != 0
         score = label.to_i

         user['score'][ALL] += score
         if labels.include?(READY)
            user['score'][READY] += score
         elsif labels.include?(IN_PROGRESS)
            user['score'][IN_PROGRESS] += score
         elsif labels.include?(UNDER_REVIEW)
            user['score'][UNDER_REVIEW] += score
         end
         break
      end
   end
end

rows = []

users.each_pair do |login, user|
   rows << {
      :login => login,
      :count => user['count'],
      :score => user['score'][ALL],
      :ready => user['score'][READY],
      :in_progress => user['score'][IN_PROGRESS],
      :under_review => user['score'][UNDER_REVIEW],
   }
end

rows.sort! do |a, b|
   a[:score] <=> b[:score]
end

tp.set(:max_width, 80)
tp rows
